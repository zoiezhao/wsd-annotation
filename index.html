<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ËØç‰πâÊ†áÊ≥®‰ªªÂä°</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            max-width: 1400px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
            font-size: 16px;
        }
        
        /* ÁôªÂΩïÁïåÈù¢Ê†∑Âºè */
        #login-container {
            max-width: 500px;
            margin: 100px auto;
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        #login-container h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        #login-container input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        
        #login-container button {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #login-container button:hover {
            background-color: #1976D2;
        }
        
        #login-error {
            color: red;
            margin-top: 10px;
            display: none;
        }
        
        /* ‰∏ªÁïåÈù¢Ê†∑Âºè */
        #main-container {
            display: none;
        }
        
        #question-container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-family: 'Trebuchet MS', sans-serif;
        }
        
        h2 {
            font-family: 'Trebuchet MS', sans-serif;
            font-size: 22px;
            color: #2c3e50;
        }
        
        .user-info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info-left {
            font-weight: 600;
            color: #1565c0;
        }
        
        .user-info-right {
            color: #666;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logout-btn {
            background-color: #757575 !important;
            padding: 8px 20px !important;
            font-size: 14px !important;
            margin-left: 15px;
        }
        
        /* ÈÄâÈ°πÂÆπÂô® - ‰∏§ÂàóÂ∏ÉÂ±Ä */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        label {
            display: block;
            padding: 18px;
            background-color: #ffffff;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        label:hover {
            background-color: #f0f8ff;
            border-color: #2196F3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.15);
        }
        
        /* ‰ª£Á†ÅÂùóÊ†∑Âºè */
        .logic-code {
            background-color: #fafafa;
            color: #1a1a1a;
            padding: 14px;
            border-radius: 6px;
            border-left: 4px solid #2196F3;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            white-space: pre;
            overflow-x: auto;
            line-height: 1.6;
        }
        
        /* Ê†áÁ≠æÊ†∑Âºè */
        .frame-label {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 700;
            margin-top: 8px;
        }
        
        .option-number {
            font-size: 15px;
            font-weight: normal;
            color: #666;
            margin-bottom: 5px;
            display: block;
        }
        
        /* ÊäòÂè†Èù¢ÊùøÊ†∑Âºè */
        .fn-group {
            margin-bottom: 20px;
        }
        
        .fn-header {
            padding: 12px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            margin-bottom: 10px;
        }
        
        .fn-header:hover {
            opacity: 0.9;
            transform: translateX(2px);
        }
        
        .fn-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .fn-icon {
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .fn-icon.collapsed {
            transform: rotate(-90deg);
        }
        
        .fn-count {
            font-size: 13px;
            opacity: 0.8;
        }
        
        .fn-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .fn-options.collapsed {
            display: none;
        }
        
        input[type="radio"] {
            transform: scale(1.3);
            margin-right: 10px;
        }
        
        button {
            background-color: #2196F3;
            color: white;
            padding: 14px 35px;
            font-size: 17px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        button:hover {
            background-color: #1976D2;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .progress {
            color: #666;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 600;
        }
        
        /* ÊµÆÁ™óÊ†∑Âºè */
        #selected-panel {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: white;
            border: 2px solid #2196F3;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }
        
        #selected-panel.show {
            display: block;
        }
        
        .panel-header {
            background-color: #2196F3;
            color: white;
            padding: 12px 15px;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .panel-header:hover {
            background-color: #1976D2;
        }
        
        .panel-content {
            padding: 15px;
            max-width: 500px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        
        .panel-content.expanded {
            display: block;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }
        
        .saving-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 2000;
            font-size: 14px;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° - Âπ≥Êùø */
        @media (max-width: 1024px) {
            body {
                max-width: 95%;
                margin: 30px auto;
                padding: 15px;
            }
            
            #question-container {
                padding: 20px;
            }
        }
        
        /* ÂìçÂ∫îÂºèËÆæËÆ° - ÊâãÊú∫ */
        @media (max-width: 768px) {
            body {
                margin: 20px auto;
                padding: 10px;
                font-size: 15px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            h2 {
                font-size: 18px;
            }
            
            /* ÊâãÊú∫‰∏äÂçïÂàóÂ∏ÉÂ±Ä */
            .fn-options {
                grid-template-columns: 1fr !important;
            }
            
            .options-grid {
                grid-template-columns: 1fr !important;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .user-info-right {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }
            
            .user-info-left {
                width: 100%;
            }
            
            .logout-btn {
                margin-left: 0 !important;
                margin-top: 5px;
            }
            
            #question-container {
                padding: 15px;
            }
            
            label {
                padding: 15px;
            }
            
            .logic-code {
                font-size: 12px;
                padding: 10px;
            }
            
            button {
                width: 100%;
                margin-bottom: 10px;
                padding: 12px 20px;
                font-size: 16px;
            }
            
            #prev-btn, #next-btn {
                width: 48%;
                display: inline-block;
                margin-right: 2%;
            }
            
            #next-btn {
                margin-right: 0;
            }
            
            /* ÊµÆÁ™óÂú®ÊâãÊú∫‰∏äÁöÑ‰ΩçÁΩÆ */
            #selected-panel {
                bottom: 10px;
                right: 10px;
                left: 10px;
                max-width: calc(100% - 20px);
            }
            
            .panel-content {
                max-width: 100%;
            }
            
            .fn-header {
                font-size: 14px;
                padding: 10px 15px;
            }
            
            input[type="radio"] {
                transform: scale(1.5);
                margin-right: 12px;
            }
            
            #login-container {
                margin: 50px auto;
                padding: 30px 20px;
            }
        }
        
        /* ÂìçÂ∫îÂºèËÆæËÆ° - Â§ßÂ±èÂπï */
        @media (min-width: 1600px) {
            body {
                max-width: 1800px;
            }
            
            .fn-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ÁôªÂΩïÁïåÈù¢ -->
    <div id="login-container">
        <h1>ËØç‰πâÊ∂àÊ≠ßÊ†áÊ≥®Á≥ªÁªü</h1>
        <p>ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÊ†áÊ≥®ÂëòID</p>
        <input type="text" id="annotator-id-input" placeholder="‰æãÂ¶ÇÔºöannotator1" />
        <button onclick="login()">ÂºÄÂßãÊ†áÊ≥®</button>
        <div id="login-error">ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊ†áÊ≥®ÂëòID</div>
    </div>
    
    <!-- ‰∏ªÁïåÈù¢ -->
    <div id="main-container">
        <h1>ËØç‰πâÊ∂àÊ≠ßÊ†áÊ≥®</h1>
        
        <div class="user-info">
            <div class="user-info-left">
                <span id="user-name"></span>
                <button class="logout-btn" onclick="logout()">ÈÄÄÂá∫ÁôªÂΩï</button>
            <div class="user-info-right">
    <span id="progress-info"></span>
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="number" id="jump-input" placeholder="Ë∑≥ËΩ¨Ëá≥Á¨¨" min="1" style="width: 80px; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px;">
        <button class="logout-btn" onclick="jumpToQuestion()" style="background-color: #9C27B0; padding: 8px 15px;">Ë∑≥ËΩ¨</button>
        <button class="logout-btn" onclick="manualSave()" id="manual-save-btn" style="background-color: #FF9800;">üíæ Á°ÆËÆ§‰øùÂ≠ò</button>
    </div>
</div>
        </div>
        
        <div class="progress" id="progress"></div>
        
        <div id="question-container">
            <div class="loading">Loading questions...</div>
        </div>
        
        <br>
        <button onclick="previousQuestion()" id="prev-btn" style="background-color: #757575;">‚Üê ‰∏ä‰∏ÄÈ¢ò</button>
        <button onclick="submitAnswer()" id="next-btn">‰∏ã‰∏ÄÈ¢ò ‚Üí</button>
        
        <!-- ÊµÆÁ™ó -->
        <div id="selected-panel">
            <div class="panel-header" onclick="togglePanel()">
                <span id="panel-title">‚úì No selection</span>
            </div>
            <div class="panel-content" id="panel-content"></div>
        </div>
        
        <!-- ‰øùÂ≠òÊèêÁ§∫ -->
        <div class="saving-indicator" id="saving-indicator">‚úì Â∑≤‰øùÂ≠ò</div>
    </div>
    
    <script>
        // Google Apps Script Web App URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwnLzjIgJOvg_b--J5FqDnIFLr8BiREYfTGXFOi2V_2cO_91eAo22lkeqfaQkb2IDLJ/exec';
        
        // È¢úËâ≤ÊñπÊ°à
        const colorSchemes = [
            { bg: '#e3f2fd', text: '#1565c0' },
            { bg: '#fff3e0', text: '#e65100' },
            { bg: '#e8f5e9', text: '#2e7d32' },
            { bg: '#f3e5f5', text: '#6a1b9a' },
            { bg: '#fff9c4', text: '#f57f17' },
            { bg: '#e0f2f1', text: '#00695c' },
            { bg: '#fce4ec', text: '#c2185b' },
            { bg: '#f1f8e9', text: '#558b2f' }
        ];
        
        let fnColorMap = {};
        let questions = [];
        let currentQuestion = 0;
        let answers = {};
        let currentAnnotator = null;
        let saveQueue = [];
        let isSaving = false;
        
        // ÁôªÂΩï
        function login() {
            const annotatorId = document.getElementById('annotator-id-input').value.trim();
            
            if (!annotatorId) {
                document.getElementById('login-error').style.display = 'block';
                return;
            }
            
            currentAnnotator = annotatorId;
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            document.getElementById('user-name').textContent = 'Ê†áÊ≥®Âëò: ' + annotatorId;
            
            loadQuestionsAndProgress();
        }
        
        // ÈÄÄÂá∫ÁôªÂΩï
        function logout() {
            if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºüÊÇ®ÁöÑËøõÂ∫¶Â∑≤Ëá™Âä®‰øùÂ≠ò„ÄÇ')) {
                processSaveQueue(false).then(() => {
                    currentAnnotator = null;
                    answers = {};
                    currentQuestion = 0;
                    saveQueue = [];
                    document.getElementById('login-container').style.display = 'block';
                    document.getElementById('main-container').style.display = 'none';
                    document.getElementById('annotator-id-input').value = '';
                });
            }
        }
        
        // Âä†ËΩΩÈ¢òÁõÆÂíåËøõÂ∫¶
        async function loadQuestionsAndProgress() {
            try {
                const questionsResponse = await fetch('questions.json');
                questions = await questionsResponse.json();
                console.log('Loaded ' + questions.length + ' questions');
                
                const progressResponse = await fetch(SCRIPT_URL + '?action=getProgress&annotator_id=' + currentAnnotator);
                const progressData = await progressResponse.json();
                
                if (progressData.success) {
                    progressData.answered.forEach(item => {
                        answers[item.question_index] = item.selected_answer;
                    });
                    
                    currentQuestion = 0;
                    for (let i = 0; i < questions.length; i++) {
                        if (!(i in answers)) {
                            currentQuestion = i;
                            break;
                        }
                    }
                    
                    if (currentQuestion === 0 && Object.keys(answers).length === questions.length) {
                        currentQuestion = questions.length - 1;
                    }
                    
                    console.log('Loaded progress: ' + Object.keys(answers).length + ' answered, starting at question ' + (currentQuestion + 1));
                }
                
                updateProgressInfo();
                displayQuestion();
                
            } catch (error) {
                console.error('Error loading:', error);
                document.getElementById('question-container').innerHTML = 
                    '<div class="loading" style="color: red;">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï</div>';
            }
        }
        
        // Êõ¥Êñ∞ËøõÂ∫¶‰ø°ÊÅØ
        function updateProgressInfo() {
            const completed = Object.keys(answers).length;
            const total = questions.length;
            document.getElementById('progress-info').textContent = 
                `Â∑≤ÂÆåÊàê: ${completed}/${total} È¢ò (${Math.round(completed/total*100)}%)`;
        }
        
        // ‰øùÂ≠òÁ≠îÊ°àÂà∞Google SheetsÔºàÂºÇÊ≠•Ôºå‰∏çÁ≠âÂæÖÔºâ
        function saveAnswer(questionIndex, selectedAnswer) {
            saveQueue.push({
                questionIndex: questionIndex,
                selectedAnswer: selectedAnswer
            });
            
            processSaveQueue(false);
        }
        
        // Â§ÑÁêÜ‰øùÂ≠òÈòüÂàó
        async function processSaveQueue(showIndicator = false) {
            if (isSaving || saveQueue.length === 0) {
                return;
            }
            
            isSaving = true;
            const indicator = document.getElementById('saving-indicator');
            
            while (saveQueue.length > 0) {
                const item = saveQueue.shift();
                
                try {
                    const formData = new URLSearchParams();
                    formData.append('action', 'saveAnswer');
                    formData.append('annotator_id', currentAnnotator);
                    formData.append('question_index', item.questionIndex);
                    formData.append('selected_answer', item.selectedAnswer);
                    
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: formData
                    });
                    
                    if (showIndicator) {
                        indicator.style.display = 'block';
                        setTimeout(() => {
                            indicator.style.display = 'none';
                        }, 1000);
                    }
                    
                } catch (error) {
                    console.error('Error saving answer:', error);
                    saveQueue.unshift(item);
                    break;
                }
            }
            
            isSaving = false;
        }
        
        // ÊâãÂä®Á°ÆËÆ§‰øùÂ≠ò
        async function manualSave() {
            const saveBtn = document.getElementById('manual-save-btn');
            const originalText = saveBtn.innerHTML;
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = '‰øùÂ≠ò‰∏≠...';
            saveBtn.style.backgroundColor = '#999';
            
            try {
                const selected = document.querySelector('input[name="answer"]:checked');
                if (selected) {
                    const selectedAnswer = parseInt(selected.value);
                    
                    if (answers[currentQuestion] !== selectedAnswer) {
                        answers[currentQuestion] = selectedAnswer;
                        saveQueue.push({
                            questionIndex: currentQuestion,
                            selectedAnswer: selectedAnswer
                        });
                        updateProgressInfo();
                    }
                }
                
                await processSaveQueue(true);
                
                saveBtn.innerHTML = '‚úì Â∑≤‰øùÂ≠ò';
                saveBtn.style.backgroundColor = '#4CAF50';
                
                setTimeout(() => {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.backgroundColor = '#FF9800';
                }, 2000);
                
            } catch (error) {
                console.error('Manual save error:', error);
                saveBtn.innerHTML = '‚úó ‰øùÂ≠òÂ§±Ë¥•';
                saveBtn.style.backgroundColor = '#f44336';
                
                setTimeout(() => {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.backgroundColor = '#FF9800';
                }, 3000);
            }
        }
        
        // ‰∏∫FNÊ†áÁ≠æÂàÜÈÖçÈ¢úËâ≤
        function assignFNColors(definitions) {
            const uniqueFNs = [...new Set(definitions.map(d => d.label))];
            uniqueFNs.forEach((fn, index) => {
                if (!fnColorMap[fn]) {
                    const color = colorSchemes[index % colorSchemes.length];
                    fnColorMap[fn] = color;
                }
            });
        }
        
        // ÊòæÁ§∫È¢òÁõÆ
        function displayQuestion() {
            if (questions.length === 0) {
                return;
            }
            
            if (Object.keys(answers).length === questions.length) {
                showAllCompleted();
                return;
            }
            
            const q = questions[currentQuestion];
            fnColorMap = {};
            assignFNColors(q.definitions);
            
            const sortedDefs = q.definitions.map((def, originalIndex) => ({
                ...def,
                originalIndex: originalIndex
            })).sort((a, b) => a.label.localeCompare(b.label));
            
            const fnGroups = {};
            sortedDefs.forEach(def => {
                if (!fnGroups[def.label]) {
                    fnGroups[def.label] = [];
                }
                fnGroups[def.label].push(def);
            });
            
            let html = `
                <h2>Sentence: "${q.sentence}"</h2>
                <p>Which interpretation of the word "<strong>${q.word}</strong>" is the most appropriate?</p>
            `;
            
            let displayIndex = 0;
            Object.keys(fnGroups).forEach(fnLabel => {
                const color = fnColorMap[fnLabel];
                const options = fnGroups[fnLabel];
                
                html += `
                    <div class="fn-group">
                        <div class="fn-header" style="background-color: ${color.bg}; color: ${color.text};" onclick="toggleFNGroup('${fnLabel}')">
                            <div class="fn-title">
                                <span class="fn-icon" id="icon-${fnLabel}">‚ñº</span>
                                <span>${fnLabel}</span>
                            </div>
                            <span class="fn-count">(${options.length} option${options.length > 1 ? 's' : ''})</span>
                        </div>
                        <div class="fn-options" id="options-${fnLabel}">
                `;
                
                options.forEach(def => {
                    html += `
                        <label>
                            <input type="radio" name="answer" value="${def.originalIndex}">
                            <span class="option-number" style="display: inline;">Option ${displayIndex + 1}:</span>
                            <div class="logic-code">${def.code}</div>
                            <span class="frame-label" style="background-color: ${color.bg}; color: ${color.text};">${def.label}</span>
                        </label>
                    `;
                    displayIndex++;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('question-container').innerHTML = html;
            document.getElementById('progress').innerHTML = `Question ${currentQuestion + 1} of ${questions.length}`;
            
            if (currentQuestion in answers) {
                const savedAnswer = answers[currentQuestion];
                const radio = document.querySelector(`input[name="answer"][value="${savedAnswer}"]`);
                if (radio) {
                    radio.checked = true;
                    updateSelectedPanel();
                }
            }
            
            document.querySelectorAll('input[name="answer"]').forEach(radio => {
                radio.addEventListener('change', updateSelectedPanel);
            });
            
            const prevBtn = document.getElementById('prev-btn');
            if (currentQuestion === 0) {
                prevBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'inline-block';
            }
        }
        
        // Êèê‰∫§Á≠îÊ°à
        function submitAnswer() {
            const selected = document.querySelector('input[name="answer"]:checked');
            
            if (!selected) {
                alert('Please select an answer first!');
                return;
            }
            
            const selectedAnswer = parseInt(selected.value);
            
            answers[currentQuestion] = selectedAnswer;
            saveAnswer(currentQuestion, selectedAnswer);
            updateProgressInfo();
            
            currentQuestion++;
            
            if (currentQuestion < questions.length) {
                displayQuestion();
                window.scrollTo(0, 0);
                document.getElementById('selected-panel').classList.remove('show');
                document.getElementById('panel-content').classList.remove('expanded');
            } else {
                showAllCompleted();
            }
        }
        
        // ‰∏ä‰∏ÄÈ¢ò
        function previousQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                displayQuestion();
                window.scrollTo(0, 0);
            }
        }
        
        // ÊòæÁ§∫ÂÖ®ÈÉ®ÂÆåÊàê
        function showAllCompleted() {
            let html = '<h2>üéâ ÊÅ≠ÂñúÔºÅÊÇ®Â∑≤ÂÆåÊàêÊâÄÊúâÊ†áÊ≥®‰ªªÂä°ÔºÅ</h2>';
            html += `<p>ÊÄªÂÖ±ÂÆåÊàêÔºö${questions.length} È¢ò</p>`;
            html += '<p>ÊÑüË∞¢ÊÇ®ÁöÑË¥°ÁåÆÔºÅÊÇ®ÂèØ‰ª•ÂÆâÂÖ®Âú∞ÂÖ≥Èó≠Ê≠§È°µÈù¢„ÄÇ</p>';
            
            document.getElementById('question-container').innerHTML = html;
            document.getElementById('progress').innerHTML = '';
            document.getElementById('prev-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';
        }
        
        // Êõ¥Êñ∞ÊµÆÁ™óÂÜÖÂÆπ
        function updateSelectedPanel() {
            const selected = document.querySelector('input[name="answer"]:checked');
            const panel = document.getElementById('selected-panel');
            
            if (!selected) {
                panel.classList.remove('show');
                return;
            }
            
            const index = parseInt(selected.value);
            const def = questions[currentQuestion].definitions[index];
            
            const sortedDefs = questions[currentQuestion].definitions.map((def, originalIndex) => ({
                ...def,
                originalIndex: originalIndex
            })).sort((a, b) => a.label.localeCompare(b.label));
            
            const displayIndex = sortedDefs.findIndex(d => d.originalIndex === index);
            
            document.getElementById('panel-title').textContent = `‚úì Option ${displayIndex + 1} selected (click to view)`;
            
            const color = fnColorMap[def.label];
            document.getElementById('panel-content').innerHTML = `
                <div class="logic-code">${def.code}</div>
                <span class="frame-label" style="background-color: ${color.bg}; color: ${color.text};">${def.label}</span>
            `;
            
            panel.classList.add('show');
        }
        
        // ÂàáÊç¢ÊµÆÁ™óÂ±ïÂºÄ/Êî∂Ëµ∑
        function togglePanel() {
            const content = document.getElementById('panel-content');
            content.classList.toggle('expanded');
        }
        
        // ÂàáÊç¢FNÁªÑÁöÑÂ±ïÂºÄ/Êî∂Ëµ∑
        function toggleFNGroup(fnLabel) {
            const options = document.getElementById('options-' + fnLabel);
            const icon = document.getElementById('icon-' + fnLabel);
            
            options.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
        }
        // Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÈ¢òÁõÆ
function jumpToQuestion() {
    const input = document.getElementById('jump-input');
    const targetQuestion = parseInt(input.value);
    
    if (!targetQuestion || targetQuestion < 1 || targetQuestion > questions.length) {
        alert(`ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈ¢òÁõÆÁºñÂè∑ (1-${questions.length})`);
        return;
    }
    
    // ‰øùÂ≠òÂΩìÂâçÈ¢òÁõÆÁöÑÁ≠îÊ°àÔºàÂ¶ÇÊûúÊúâÈÄâÊã©Ôºâ
    const selected = document.querySelector('input[name="answer"]:checked');
    if (selected) {
        const selectedAnswer = parseInt(selected.value);
        if (answers[currentQuestion] !== selectedAnswer) {
            answers[currentQuestion] = selectedAnswer;
            saveAnswer(currentQuestion, selectedAnswer);
            updateProgressInfo();
        }
    }
    
    // Ë∑≥ËΩ¨
    currentQuestion = targetQuestion - 1;
    displayQuestion();
    window.scrollTo(0, 0);
    document.getElementById('selected-panel').classList.remove('show');
    document.getElementById('panel-content').classList.remove('expanded');
    input.value = ''; // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
}
        
        // È°µÈù¢ÂÖ≥Èó≠ÂâçÁ°Æ‰øù‰øùÂ≠òÂÆåÊàê
        window.addEventListener('beforeunload', function (e) {
            if (saveQueue.length > 0) {
                e.preventDefault();
                e.returnValue = 'ËøòÊúâÊï∞ÊçÆÊ≠£Âú®‰øùÂ≠ò‰∏≠...';
                return e.returnValue;
            }
        });
        
        // ÂÆöÊúüÊ£ÄÊü•‰øùÂ≠òÈòüÂàó
        setInterval(() => {
            if (saveQueue.length > 0 && !isSaving) {
                processSaveQueue(false);
            }
        }, 2000);
    </script>
    
</body>

</html>

